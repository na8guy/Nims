<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <title>Nims Climb</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        body {
            background: #1a1a2e;
            color: #fff;
            height: 100vh;
            overflow: hidden;
            display: grid;
            grid-template-columns: 250px 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 10px;
        }
        #header {
            grid-column: 1 / 3;
            background: #16213e;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        #balance {
            font-size: 18px;
        }
        #multiplier {
            font-size: 24px;
            font-weight: bold;
            color: #e94560;
        }
        #sidebar {
            grid-column: 1 / 2;
            grid-row: 2 / 4;
            background: #0f3460;
            padding: 20px;
            overflow-y: auto;
        }
        #sidebar button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #e94560;
            border: none;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            transition: background 0.3s;
        }
        #sidebar button:hover {
            background: #ff6b6b;
        }
        #gameCanvas {
            grid-column: 2 / 3;
            grid-row: 2 / 3;
            width: 100%;
            height: 100%;
            background: #1a1a2e;
        }
        #controls {
            grid-column: 2 / 3;
            grid-row: 3 / 4;
            padding: 10px;
            background: #16213e;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        #stakeInput, #tokenSelect {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background: #fff;
            color: #000;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #e94560;
            color: #fff;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background: #ff6b6b;
        }
        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            width: 400px;
            max-width: 90%;
            text-align: center;
        }
        .modal-content input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        #error, #cashout-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #e94560;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            z-index: 999;
        }
        #jackpot, #raffle {
            margin: 20px 0;
            font-size: 16px;
        }
        @keyframes scale {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .animate-multiplier {
            animation: scale 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <div id="header">
        <div id="multiplier">1.00x</div>
        <div id="balance">BNB: 0 | NIMS: 0</div>
    </div>
    <div id="sidebar">
        <button onclick="showModal('deposit')">Deposit Address</button>
        <button onclick="showModal('withdraw')">Withdraw Funds</button>
        <div id="jackpot">Community Jackpot: 0 NIMS</div>
        <div id="raffle">Raffle Tickets: 0</div>
    </div>
    <canvas id="gameCanvas"></canvas>
    <div id="controls">
        <input type="number" id="stakeInput" placeholder="Stake (0.1-10)" step="0.1" min="0.1" max="10">
        <select id="tokenSelect">
            <option value="BNB">BNB</option>
            <option value="NIMS">NIMS</option>
        </select>
        <button id="startButton">Start Game</button>
        <button id="cashoutButton" disabled>Cash Out</button>
        <button id="restButton" disabled>Rest</button>
    </div>
    <div id="modal">
        <div class="modal-content">
            <h2 id="modal-title"></h2>
            <p id="modal-body"></p>
            <input id="withdraw-amount" type="number" placeholder="Amount" style="display: none;">
            <input id="withdraw-address" type="text" placeholder="Address" style="display: none;">
            <button onclick="closeModal()">Close</button>
            <button id="withdraw-submit" onclick="submitWithdrawal()" style="display: none;">Submit</button>
        </div>
    </div>
    <div id="error"></div>
    <div id="cashout-message"></div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const multiplierDisplay = document.getElementById('multiplier');
        const balanceDisplay = document.getElementById('balance');
        const stakeInput = document.getElementById('stakeInput');
        const tokenSelect = document.getElementById('tokenSelect');
        const startButton = document.getElementById('startButton');
        const cashoutButton = document.getElementById('cashoutButton');
        const restButton = document.getElementById('restButton');
        const errorDisplay = document.getElementById('error');
        const cashoutMessage = document.getElementById('cashout-message');
        const jackpotDisplay = document.getElementById('jackpot');
        const raffleDisplay = document.getElementById('raffle');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const withdrawAmount = document.getElementById('withdraw-amount');
        const withdrawAddress = document.getElementById('withdraw-address');
        const withdrawSubmit = document.getElementById('withdraw-submit');

        let gameData = null;
        let sessionId = null;
        let stake = 0;
        let token = 'BNB';
        let crashPoint = 0;
        let multiplier = 1;
        let timeElapsed = 0;
        let isGameRunning = false;
        let climber = { x: 100, y: 0, angle: 0 };
        const climbSpeed = 2;
        let pathProgress = 0;

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        function showError(message) {
            errorDisplay.textContent = message;
            errorDisplay.style.display = 'block';
            setTimeout(() => errorDisplay.style.display = 'none', 5000);
            console.error('Error:', message);
        }

        function showCashout(message) {
            cashoutMessage.textContent = message;
            cashoutMessage.style.display = 'block';
            setTimeout(() => cashoutMessage.style.display = 'none', 3000);
        }

        function showModal(type) {
            modal.style.display = 'flex';
            if (type === 'deposit') {
                modalTitle.textContent = 'Deposit Address';
                modalBody.textContent = `BNB: ${gameData.bnb_address || 'N/A'}\nNIMS: ${gameData.nims_address || 'N/A'}`;
                withdrawAmount.style.display = 'none';
                withdrawAddress.style.display = 'none';
                withdrawSubmit.style.display = 'none';
            } else if (type === 'withdraw') {
                modalTitle.textContent = 'Withdraw Funds';
                modalBody.textContent = 'Enter amount and address:';
                withdrawAmount.style.display = 'block';
                withdrawAddress.style.display = 'block';
                withdrawSubmit.style.display = 'block';
            }
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        function submitWithdrawal() {
            const amount = parseFloat(withdrawAmount.value);
            const address = withdrawAddress.value;
            if (!amount || amount <= 0 || !address) {
                showError('Invalid amount or address');
                return;
            }
            Telegram.WebApp.sendData(JSON.stringify({
                action: 'withdraw',
                amount: amount.toFixed(8),
                address,
                token: tokenSelect.value
            }));
            showError('Withdrawal request sent');
            closeModal();
        }

        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            climber.y = canvas.height - 50;
        }

        function drawPath() {
            ctx.beginPath();
            ctx.strokeStyle = '#e94560';
            ctx.lineWidth = 5;
            ctx.moveTo(100, canvas.height);
            for (let t = 0; t <= pathProgress; t += 0.01) {
                const x = 100 + t * (canvas.width - 200);
                const y = canvas.height - (t * canvas.height * 0.8);
                ctx.lineTo(x, y);
            }
            ctx.stroke();
        }

        function drawClimber() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawPath();
            ctx.save();
            ctx.translate(climber.x, climber.y);
            ctx.rotate(climber.angle);
            ctx.fillStyle = '#ff6b6b';
            ctx.beginPath();
            ctx.moveTo(20, 0);
            ctx.lineTo(-10, -10);
            ctx.lineTo(-10, 10);
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        }

        function updateGame() {
            if (!isGameRunning) return;
            timeElapsed += 0.016;
            multiplier = 1 + timeElapsed * 0.03;
            pathProgress = Math.min(timeElapsed / 10, 1);
            climber.x = 100 + pathProgress * (canvas.width - 200);
            climber.y = canvas.height - (pathProgress * canvas.height * 0.8);
            climber.angle = Math.atan2(-0.8 * canvas.height, canvas.width - 200) * pathProgress;
            multiplierDisplay.textContent = multiplier.toFixed(2) + 'x';
            multiplierDisplay.classList.add('animate-multiplier');
            setTimeout(() => multiplierDisplay.classList.remove('animate-multiplier'), 500);
            drawClimber();
            console.log(`Game tick: multiplier=${multiplier.toFixed(2)}, crashPoint=${crashPoint}`);
            if (crashPoint && multiplier >= crashPoint) {
                isGameRunning = false;
                multiplierDisplay.textContent = 'Avalanche!';
                cashoutButton.disabled = true;
                restButton.disabled = true;
                startButton.disabled = false;
                Telegram.WebApp.sendData(JSON.stringify({
                    action: 'lost',
                    session_id: sessionId,
                    stake: stake.toString(),
                    token
                }));
                resetGame();
            } else {
                const safetyZones = [1.5, 3.0, 5.0];
                restButton.disabled = !safetyZones.some(zone => Math.abs(multiplier - zone) < 0.1);
            }
            requestAnimationFrame(updateGame);
        }

        function resetGame() {
            isGameRunning = false;
            multiplier = 1;
            timeElapsed = 0;
            pathProgress = 0;
            climber = { x: 100, y: canvas.height - 50, angle: 0 };
            multiplierDisplay.textContent = '1.00x';
            cashoutButton.disabled = true;
            restButton.disabled = true;
            startButton.disabled = false;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            console.log('Game reset');
        }

        function validateStake() {
            const value = parseFloat(stakeInput.value);
            return value >= 0.1 && value <= 10 && !isNaN(value);
        }

        try {
            const rawData = getQueryParam('data');
            if (!rawData) throw new Error('No game data provided');
            gameData = JSON.parse(decodeURIComponent(rawData));
            console.log('Game data:', gameData);
            balanceDisplay.textContent = `BNB: ${parseFloat(gameData.bnb_balance).toFixed(8)} | NIMS: ${parseFloat(gameData.nims_balance).toFixed(4)}`;
            jackpotDisplay.textContent = `Community Jackpot: ${parseFloat(gameData.jackpot || 0).toFixed(4)} NIMS`;
            raffleDisplay.textContent = `Raffle Tickets: ${gameData.raffle_tickets || 0}`;
            if (gameData.game_started) {
                sessionId = gameData.game_started.session_id;
                stake = parseFloat(gameData.game_started.stake);
                token = gameData.game_started.token;
                crashPoint = parseFloat(gameData.game_started.crash_point);
                console.log('Game started:', { sessionId, stake, token, crashPoint });
                if (!sessionId || !stake || !token || !crashPoint) {
                    throw new Error('Incomplete game_started data');
                }
                isGameRunning = true;
                startButton.disabled = true;
                cashoutButton.disabled = false;
                restButton.disabled = false;
                stakeInput.value = stake;
                tokenSelect.value = token;
                stakeInput.disabled = true;
                tokenSelect.disabled = true;
                requestAnimationFrame(updateGame);
            }
        } catch (e) {
            showError(`Failed to load game: ${e.message}`);
            resetGame();
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        startButton.addEventListener('click', () => {
            if (!validateStake()) {
                showError('Stake must be between 0.1 and 10');
                return;
            }
            const stakeValue = parseFloat(stakeInput.value).toFixed(8);
            token = tokenSelect.value;
            console.log('Starting game:', { stake: stakeValue, token });
            startButton.disabled = true;
            stakeInput.disabled = true;
            tokenSelect.disabled = true;
            Telegram.WebApp.sendData(JSON.stringify({
                action: 'start_game',
                token,
                stake: stakeValue
            }));
        });

        cashoutButton.addEventListener('click', () => {
            if (!isGameRunning) return;
            isGameRunning = false;
            cashoutButton.disabled = true;
            showCashout('Cashing out...');
            console.log('Cashout:', { sessionId, stake, token, multiplier });
            Telegram.WebApp.sendData(JSON.stringify({
                action: 'cashout',
                session_id: sessionId,
                stake: stake.toString(),
                token,
                multiplier: multiplier.toFixed(4)
            }));
            Telegram.WebApp.onEvent('message', (data) => {
                showCashout(`Cashed out ${multiplier.toFixed(2)}x!`);
                resetGame();
            });
        });

        restButton.addEventListener('click', () => {
            if (!isGameRunning) return;
            const safetyZones = [1.5, 3.0, 5.0];
            if (!safetyZones.some(zone => Math.abs(multiplier - zone) < 0.1)) {
                showError('Can only rest at 1.5x, 3x, or 5x');
                return;
            }
            isGameRunning = false;
            Telegram.WebApp.sendData(JSON.stringify({
                action: 'rest',
                session_id: sessionId,
                token,
                multiplier: multiplier.toFixed(4)
            }));
            resetGame();
        });

        Telegram.WebApp.ready();
        console.log('WebApp initialized');
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nims Climb</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            width: 100%;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #1a73e8;
        }
        .balance {
            margin: 20px 0;
            font-size: 1.2em;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            background-color: #1a73e8;
            color: white;
            font-size: 1em;
            cursor: pointer;
        }
        button:hover {
            background-color: #1557b0;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .error {
            color: red;
            margin: 10px 0;
        }
        .debug {
            font-size: 0.8em;
            color: #666;
            margin-top: 20px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Nims Climb</h1>
        <div id="error" class="error"></div>
        <div id="balance" class="balance"></div>
        <div id="game-status"></div>
        <div>
            <input id="stake-input" type="number" placeholder="Stake (0.1-10.0)" step="0.1" min="0.1" max="10.0" style="padding: 10px; margin: 10px;">
            <select id="token-select">
                <option value="BNB">BNB</option>
                <option value="NIMS">NIMS</option>
            </select>
            <button id="start-game">Start Game</button>
            <button id="cashout" disabled>Cash Out</button>
            <button id="buy-ticket">Buy Raffle Ticket</button>
            <button id="refresh-balance">Refresh Balance</button>
        </div>
        <div id="debug" class="debug"></div>
    </div>

    <script>
        // Debug logging function
        function logDebug(message) {
            console.log(message);
            const debugDiv = document.getElementById('debug');
            debugDiv.innerHTML += `<p>${new Date().toISOString()} - ${message}</p>`;
        }

        // Error display function
        function showError(message) {
            console.error(message);
            document.getElementById('error').textContent = message;
        }

        // Initialize WebApp
        function initializeWebApp() {
            logDebug('Checking Telegram WebApp SDK...');
            if (!window.Telegram || !window.Telegram.WebApp) {
                showError('Telegram WebApp SDK not loaded. Please open in Telegram.');
                return false;
            }

            const webApp = window.Telegram.WebApp;
            webApp.ready();

            // Log initialization details
            logDebug(`WebApp SDK available: ${!!window.Telegram.WebApp}`);
            logDebug(`initData: ${webApp.initData || 'none'}`);
            logDebug(`URL params: ${window.location.search}`);

            // Parse query parameter 'data'
            const urlParams = new URLSearchParams(window.location.search);
            const data = urlParams.get('data');
            if (!data) {
                showError('No initialization data provided. Please reload.');
                return false;
            }

            try {
                const gameData = JSON.parse(decodeURIComponent(data));
                logDebug(`Parsed game data: ${JSON.stringify(gameData)}`);
                return gameData;
            } catch (e) {
                showError('Invalid initialization data. Please reload.');
                logDebug(`Parse error: ${e.message}`);
                return false;
            }
        }

        // Update UI with game data
        function updateUI(gameData) {
            if (!gameData) return;
            const balanceDiv = document.getElementById('balance');
            balanceDiv.innerHTML = `
                BNB: ${parseFloat(gameData.bnb_balance).toFixed(8)}<br>
                NIMS: ${parseFloat(gameData.nims_balance).toFixed(4)}
            `;
            if (gameData.game_started) {
                const statusDiv = document.getElementById('game-status');
                statusDiv.innerHTML = `
                    Game Started!<br>
                    Stake: ${parseFloat(gameData.game_started.stake).toFixed(8)} ${gameData.game_started.token}<br>
                    Session ID: ${gameData.game_started.session_id}
                `;
                document.getElementById('start-game').disabled = true;
                document.getElementById('cashout').disabled = false;
            } else {
                document.getElementById('game-status').innerHTML = '';
                document.getElementById('start-game').disabled = false;
                document.getElementById('cashout').disabled = true;
            }
        }

        // Send data to bot
        function sendToBot(data) {
    if (!window.Telegram.WebApp) {
        showError('Cannot send data. Telegram WebApp not initialized.');
        return;
    }
    try {
        window.Telegram.WebApp.sendData(JSON.stringify(data));
        logDebug(`Sent to bot: ${JSON.stringify(data)}`);
    } catch (e) {
        showError('Failed to send data to bot. Please try again.');
        logDebug(`Send error: ${e.message}`);
    }
}

        // Main initialization
        let gameData = null;
        let multiplier = 1.0; // Simulated multiplier for demo

        document.addEventListener('DOMContentLoaded', () => {
            gameData = initializeWebApp();
            if (gameData) {
                updateUI(gameData);
            }

            // Start game button
            document.getElementById('start-game').addEventListener('click', () => {
                const stake = document.getElementById('stake-input').value;
                const token = document.getElementById('token-select').value;
                if (!stake || isNaN(stake) || stake < 0.1 || stake > 10.0) {
                    showError('Stake must be between 0.1 and 10.0');
                    return;
                }
                const data = {
                    action: 'start_game',
                    token: token,
                    stake: stake
                };
                sendToBot(data);
            });

            // Cash out button
            document.getElementById('cashout').addEventListener('click', () => {
                if (!gameData?.game_started) {
                    showError('No active game to cash out.');
                    return;
                }
                const data = {
                    action: 'cashout',
                    session_id: gameData.game_started.session_id,
                    stake: gameData.game_started.stake,
                    multiplier: multiplier.toFixed(4),
                    token: gameData.game_started.token
                };
                sendToBot(data);
            });

            // Buy raffle ticket button
            document.getElementById('buy-ticket').addEventListener('click', () => {
                sendToBot({ action: 'buy_raffle_ticket' });
            });

            // Refresh balance button
            document.getElementById('refresh-balance').addEventListener('click', () => {
                sendToBot({ action: 'refresh_balance' });
            });

            // Simulate game multiplier (replace with actual game logic)
            setInterval(() => {
                if (gameData?.game_started) {
                    multiplier += 0.1;
                    document.getElementById('game-status').innerHTML = `
                        Game Started!<br>
                        Stake: ${parseFloat(gameData.game_started.stake).toFixed(8)} ${gameData.game_started.token}<br>
                        Session ID: ${gameData.game_started.session_id}<br>
                        Multiplier: ${multiplier.toFixed(2)}x
                    `;
                }
            }, 1000);
        });

        // Handle WebApp close or crash
        window.Telegram.WebApp.onEvent('viewportChanged', () => {
            logDebug('Viewport changed');
        });
    </script>
</body>
</html>

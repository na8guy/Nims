<!DOCTYPE html>
<html>
<head>
    <title>Nims Climb</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: Arial; text-align: center; background: #87CEEB; margin: 0; padding: 20px; font-size: 20px; }
        canvas { border: 1px solid black; background: #808080; display: none; width: 600px; height: 800px; margin: 0 auto; }
        #ui { margin-bottom: 20px; }
        button { padding: 15px 30px; margin: 10px; font-size: 24px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 5px; }
        select, input { padding: 10px; font-size: 24px; margin: 10px; }
        #result { font-size: 24px; margin-top: 20px; color: #ff4444; }
        #cashoutBtn { font-size: 36px; font-weight: bold; padding: 20px 40px; background-color: #FFD700; color: black; position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); }
        h2 { font-size: 36px; }
        h3 { font-size: 28px; }
        p { font-size: 28px; }
        .section { margin: 20px 0; padding: 15px; background: rgba(255, 255, 255, 0.8); border-radius: 10px; }
    </style>
</head>
<body>
    <div id="ui">
        <h2>üèî Nims Climb</h2>
        <p>Balance: <span id="bnbBalance">0</span> BNB | <span id="nimsBalance">0</span> NIMS</p>
        <button id="refreshBtn">Refresh Balance</button>

        <!-- Game Controls -->
        <div class="section" id="gameControls">
            <h3>Play Game</h3>
            <label>Token: 
                <select id="tokenSelect">
                    <option value="BNB">BNB</option>
                    <option value="NIMS">NIMS</option>
                </select>
            </label><br>
            <label>Stake (0.1‚Äì10): 
                <input type="number" id="stakeInput" step="0.01" min="0.1" max="10" value="0.1">
            </label><br>
            <button id="startBtn">Start Climbing</button>
        </div>

        <!-- Wallet Actions -->
        <div class="section" id="walletActions">
            <h3>Wallet</h3>
            <label>Amount: <input type="number" id="amountInput" step="0.01" min="0.1" value="0.1"></label><br>
            <label>Token: <select id="walletTokenSelect">
                <option value="BNB">BNB</option>
                <option value="NIMS">NIMS</option>
            </select></label><br>
            <button id="depositBtn">Deposit</button>
            <button id="withdrawBtn">Withdraw</button>
            <p id="depositAddress" style="display: none; font-size: 20px; word-wrap: break-word;"></p>
        </div>

        <!-- Raffle -->
        <div class="section" id="raffleActions">
            <h3>Raffle (1 NIMS/ticket)</h3>
            <button id="buyRaffleBtn">Buy Raffle Ticket</button>
        </div>
    </div>
    <canvas id="gameCanvas" width="600" height="800"></canvas>
    <button id="cashoutBtn" style="display: none;">Cash Out</button>
    <div id="result"></div>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const cashoutBtn = document.getElementById('cashoutBtn');
        const depositBtn = document.getElementById('depositBtn');
        const withdrawBtn = document.getElementById('withdrawBtn');
        const buyRaffleBtn = document.getElementById('buyRaffleBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const resultDiv = document.getElementById('result');
        const depositAddressDiv = document.getElementById('depositAddress');
        let height = 0;
        let multiplier = 1.0;
        let gameActive = false;
        let stake, token, userId;

        // Parse initial data from URL
        const urlParams = new URLSearchParams(window.location.search);
        const gameData = JSON.parse(urlParams.get('data') || '{}');
        userId = gameData.user_id || (Telegram.WebApp.initDataUnsafe.user ? Telegram.WebApp.initDataUnsafe.user.id : null);
        const bnbBalance = gameData.bnb_balance || 0.0;
        const nimsBalance = gameData.nims_balance || 0.0;
        document.getElementById('bnbBalance').textContent = bnbBalance.toFixed(4);
        document.getElementById('nimsBalance').textContent = nimsBalance.toFixed(4);

        if (!userId) {
            resultDiv.textContent = "Error: Unable to get user ID.";
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#808080';
            ctx.fillRect(0, 0, canvas.width, canvas.height); // Mountain
            ctx.fillStyle = 'white';
            ctx.font = 'bold 40px Arial';
            ctx.fillText(`Multiplier: ${multiplier.toFixed(2)}x`, 20, 60);
            ctx.fillText(`Winnings: ${(stake * multiplier).toFixed(4)} ${token}`, 20, 110);
            ctx.fillStyle = 'red';
            ctx.fillRect(280, 760 - height * 2, 40, 40); // Climber
        }

        function gameLoop() {
            if (!gameActive) return;
            height += 5;
            multiplier += Math.random() * 0.1;
            draw();

            if (Math.random() < height / 1000) { // Avalanche
                gameActive = false;
                ctx.fillText("Avalanche! You lost!", 150, 400);
                resultDiv.textContent = `Lost ${stake} ${token}!`;
                Telegram.WebApp.sendData(JSON.stringify({
                    action: 'lost',
                    stake: stake,
                    token: token
                }));
                setTimeout(() => Telegram.WebApp.close(), 2000);
            } else if (height >= 250) { // Summit
                gameActive = false;
                ctx.fillText("Summit Reached!", 150, 400);
                resultDiv.textContent = `Won ${(stake * multiplier).toFixed(4)} ${token}!`;
                Telegram.WebApp.sendData(JSON.stringify({
                    action: 'cashout',
                    stake: stake,
                    token: token,
                    multiplier: multiplier
                }));
                setTimeout(() => Telegram.WebApp.close(), 2000);
            } else {
                setTimeout(gameLoop, 500);
            }
        }

        startBtn.addEventListener('click', () => {
            token = document.getElementById('tokenSelect').value;
            stake = parseFloat(document.getElementById('stakeInput').value);
            const balance = token === 'BNB' ? bnbBalance : nimsBalance;

            if (stake < 0.1 || stake > 10) {
                resultDiv.textContent = `Stake must be between 0.1 and 10 ${token}!`;
                return;
            }
            if (stake > balance) {
                resultDiv.textContent = `Insufficient balance! Max: ${balance.toFixed(4)} ${token}`;
                return;
            }

            Telegram.WebApp.sendData(JSON.stringify({
                action: 'start_game',
                stake: stake,
                token: token
            }));
            document.getElementById('ui').style.display = 'none';
            canvas.style.display = 'block';
            cashoutBtn.style.display = 'block'; // Ensure visibility
            gameActive = true;
            draw();
            gameLoop();
        });

        cashoutBtn.addEventListener('click', () => {
            if (gameActive) {
                gameActive = false;
                resultDiv.textContent = `Cashed out ${(stake * multiplier).toFixed(4)} ${token}!`;
                Telegram.WebApp.sendData(JSON.stringify({
                    action: 'cashout',
                    stake: stake,
                    token: token,
                    multiplier: multiplier
                }));
                setTimeout(() => Telegram.WebApp.close(), 2000);
            }
        });

        depositBtn.addEventListener('click', () => {
            const amount = parseFloat(document.getElementById('amountInput').value);
            const token = document.getElementById('walletTokenSelect').value;
            if (amount < 0.1) {
                resultDiv.textContent = `Deposit must be at least 0.1 ${token}!`;
                return;
            }
            // Simulate wallet address (replace with real integration later)
            const fakeAddress = token === 'BNB' ? "bnb1x...fakeaddress123" : "nims1x...fakeaddress456";
            depositAddressDiv.textContent = `Send ${amount} ${token} to: ${fakeAddress} (Simulated - Confirm in Telegram)`;
            depositAddressDiv.style.display = 'block';
            Telegram.WebApp.sendData(JSON.stringify({
                action: 'deposit',
                amount: amount,
                token: token
            }));
            setTimeout(() => Telegram.WebApp.close(), 3000); // Longer delay to read address
        });

        withdrawBtn.addEventListener('click', () => {
            const amount = parseFloat(document.getElementById('amountInput').value);
            const token = document.getElementById('walletTokenSelect').value;
            const balance = token === 'BNB' ? bnbBalance : nimsBalance;
            if (amount < 0.1) {
                resultDiv.textContent = `Withdrawal must be at least 0.1 ${token}!`;
                return;
            }
            if (amount > balance) {
                resultDiv.textContent = `Insufficient balance! Max: ${balance.toFixed(4)} ${token}`;
                return;
            }
            Telegram.WebApp.sendData(JSON.stringify({
                action: 'withdraw',
                amount: amount,
                token: token
            }));
            resultDiv.textContent = `Withdrawal of ${amount} ${token} requested. Check Telegram for confirmation.`;
            setTimeout(() => Telegram.WebApp.close(), 2000);
        });

        buyRaffleBtn.addEventListener('click', () => {
            Telegram.WebApp.sendData(JSON.stringify({
                action: 'buy_raffle_ticket'
            }));
            resultDiv.textContent = "Purchasing raffle ticket...";
            setTimeout(() => Telegram.WebApp.close(), 1000);
        });

        refreshBtn.addEventListener('click', () => {
            Telegram.WebApp.sendData(JSON.stringify({
                action: 'refresh_balance'
            }));
            resultDiv.textContent = "Refreshing balances...";
            setTimeout(() => Telegram.WebApp.close(), 1000);
        });

        Telegram.WebApp.ready();
    </script>
</body>
</html>

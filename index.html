<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nims Climb</title>
    <script src="https://telegram.org/js/telegram-web-app.js" async></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f0f0; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #007bff; }
        .balance { margin-bottom: 20px; }
        .balance p { margin: 5px 0; font-size: 16px; }
        .controls { display: flex; flex-direction: column; gap: 10px; }
        select, input, button { padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        #game-area { margin-top: 20px; text-align: center; }
        #status { margin-top: 10px; font-weight: bold; }
        .error { color: red; }
        #climbing-area { display: none; margin-top: 20px; }
        #altitude { font-size: 24px; color: #007bff; }
        #multiplier { font-size: 20px; color: #28a745; }
        #mountain { width: 100%; height: 200px; background: linear-gradient(to top, #d2b48c, #fff); position: relative; overflow: hidden; }
        #nims { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); font-size: 30px; }
        #log-panel { margin-top: 20px; padding: 10px; background-color: #f9f9f9; border: 1px solid #ddd; max-height: 150px; overflow-y: auto; font-size: 12px; text-align: left; }
        .log-entry { margin: 2px 0; }
        .log-info { color: #333; }
        .log-warn { color: #ff8c00; }
        .log-error { color: #ff0000; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Nims Climb</h1>
        <div class="balance">
            <p>BNB Balance: <span id="bnb-balance">0.0000</span></p>
            <p>NIMS Balance: <span id="nims-balance">0.0000</span></p>
        </div>
        <div class="controls">
            <select id="token-select">
                <option value="BNB">BNB</option>
                <option value="NIMS">NIMS</option>
            </select>
            <input type="number" id="stake-input" placeholder="Enter stake (0.1 - 10)" step="0.1" min="0.1" max="10">
            <button id="start-button">Start Climbing</button>
            <button id="refresh-button">Refresh Balance</button>
        </div>
        <div id="game-area">
            <p id="status">Ready to climb with Nims!</p>
            <div id="climbing-area">
                <div id="mountain">
                    <span id="nims">üèãÔ∏è‚Äç‚ôÇÔ∏è</span>
                </div>
                <p>Altitude: <span id="altitude">0m</span></p>
                <p>Multiplier: <span id="multiplier">1.00x</span></p>
                <button id="cashout-button">Cash Out</button>
            </div>
        </div>
        <div id="log-panel"></div>
    </div>

    <script>
        function initializeWebApp() {
            const WebApp = window.Telegram?.WebApp;
            if (!WebApp) {
                logToUI('ERROR', 'Telegram WebApp not available on page load');
                alert("This page must be opened in Telegram WebApp");
                document.getElementById('status').textContent = 'Error: Not in Telegram WebApp';
                document.getElementById('status').classList.add('error');
                return null;
            }
            WebApp.ready();
            WebApp.expand();
            logToUI('INFO', 'Telegram WebApp initialized successfully');
            return WebApp;
        }

        let WebApp = initializeWebApp();

        // Elements
        const bnbBalanceElement = document.getElementById('bnb-balance');
        const nimsBalanceElement = document.getElementById('nims-balance');
        const tokenSelect = document.getElementById('token-select');
        const stakeInput = document.getElementById('stake-input');
        const startButton = document.getElementById('start-button');
        const refreshButton = document.getElementById('refresh-button');
        const statusElement = document.getElementById('status');
        const climbingArea = document.getElementById('climbing-area');
        const altitudeElement = document.getElementById('altitude');
        const multiplierElement = document.getElementById('multiplier');
        const cashoutButton = document.getElementById('cashout-button');
        const nimsElement = document.getElementById('nims');
        const logPanel = document.getElementById('log-panel');

        // Game state
        let gameData = { user_id: null, bnb_balance: 0.0, nims_balance: 0.0, bnb_address: '', nims_address: '', timestamp: 0 };
        let gameActive = false;
        let currentStake = 0;
        let currentToken = '';
        let climbInterval = null;

        function logToUI(level, message) {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${level.toLowerCase()}`;
            entry.textContent = `[${new Date().toISOString().slice(11, 19)}] ${level}: ${message}`;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        function logToBackend(level, message) {
            logToUI(level, message);
            WebApp = window.Telegram?.WebApp || WebApp; // Reattempt to get WebApp
            logToUI('DEBUG', `WebApp status: ${WebApp ? 'defined' : 'undefined'}`);
            if (WebApp) {
                try {
                    const logData = { action: 'log', level: level, message: message, timestamp: new Date().toISOString() };
                    WebApp.sendData(JSON.stringify(logData));
                    logToUI('DEBUG', `Sent log to backend: ${JSON.stringify(logData)}`);
                } catch (e) {
                    logToUI('ERROR', `Failed to send log to backend: ${e.message}`);
                }
            } else {
                logToUI('ERROR', 'WebApp is undefined, cannot send log to backend');
            }
        }

        function loadGameData() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            logToUI('DEBUG', `URL search params: ${window.location.search}`);
            try {
                if (dataParam) {
                    gameData = JSON.parse(decodeURIComponent(dataParam));
                    logToBackend('INFO', `Web UI received data from backend: ${JSON.stringify(gameData)}`);
                    updateUI();
                } else {
                    logToBackend('WARN', 'No data parameter found in URL');
                }
                const hash = window.location.hash.slice(1);
                logToUI('DEBUG', `URL hash: ${hash}`);
                if (hash.startsWith('start=')) {
                    const startData = JSON.parse(hash.slice(6));
                    logToBackend('INFO', `Web UI received game start confirmation: ${JSON.stringify(startData)}`);
                    startClimbing(startData);
                }
            } catch (e) {
                logToBackend('ERROR', `Web UI failed to parse data: ${e.message}`);
                statusElement.textContent = 'Error loading data.';
                statusElement.classList.add('error');
            }
        }

        function updateUI() {
            bnbBalanceElement.textContent = parseFloat(gameData.bnb_balance || 0).toFixed(4);
            nimsBalanceElement.textContent = parseFloat(gameData.nims_balance || 0).toFixed(4);
            statusElement.textContent = gameActive ? 'Nims is climbing!' : 'Ready to climb with Nims!';
            statusElement.classList.remove('error');
            climbingArea.style.display = gameActive ? 'block' : 'none';
            startButton.disabled = gameActive;
            stakeInput.disabled = gameActive;
            tokenSelect.disabled = gameActive;
            logToBackend('DEBUG', `UI updated: gameActive=${gameActive}, balances=${gameData.bnb_balance}/${gameData.nims_balance}`);
        }

        function startGame() {
            if (gameActive) {
                statusElement.textContent = 'Nims is already climbing!';
                logToBackend('WARN', 'Attempted to start game while already active');
                return;
            }

            const token = tokenSelect.value;
            const stake = parseFloat(stakeInput.value);
            logToBackend('DEBUG', `startGame called with token=${token}, stake=${stake}`);

            if (!token || !['BNB', 'NIMS'].includes(token)) {
                statusElement.textContent = 'Please select a valid token.';
                statusElement.classList.add('error');
                logToBackend('WARN', `Invalid token selected: ${token}`);
                return;
            }
            if (isNaN(stake) || stake < 0.1 || stake > 10) {
                statusElement.textContent = 'Stake must be between 0.1 and 10.';
                statusElement.classList.add('error');
                logToBackend('WARN', `Invalid stake entered: ${stakeInput.value}`);
                return;
            }

            const balance = token === 'BNB' ? parseFloat(gameData.bnb_balance) : parseFloat(gameData.nims_balance);
            logToBackend('DEBUG', `Checking balance: ${token}=${balance}`);
            if (isNaN(balance)) {
                statusElement.textContent = 'Balance data invalid. Please refresh.';
                statusElement.classList.add('error');
                logToBackend('ERROR', 'Invalid balance data in Web UI');
                return;
            }
            if (stake > balance) {
                statusElement.textContent = `Insufficient ${token} balance: ${balance.toFixed(4)}.`;
                statusElement.classList.add('error');
                logToBackend('WARN', `Insufficient ${token} balance: ${balance} < ${stake}`);
                return;
            }

            const data = { action: 'start_game', token: token, stake: stake };
            logToBackend('INFO', `Preparing to send action to backend: ${JSON.stringify(data)}`);
            statusElement.textContent = 'Starting Game...';
            WebApp = window.Telegram?.WebApp || WebApp;
            logToBackend('DEBUG', `WebApp status before sendData: ${WebApp ? 'defined' : 'undefined'}`);
            if (WebApp) {
                try {
                    WebApp.sendData(JSON.stringify(data));
                    logToBackend('INFO', 'WebApp.sendData executed successfully');
                    setTimeout(() => {
                        WebApp.close();
                        logToBackend('INFO', 'WebApp closed to trigger backend processing');
                    }, 1000);
                } catch (e) {
                    logToBackend('ERROR', `WebApp.sendData failed: ${e.message}`);
                    statusElement.textContent = 'Failed to start game. Please try again.';
                    statusElement.classList.add('error');
                    alert(`Failed to start game: ${e.message}`);
                }
            } else {
                logToBackend('ERROR', 'WebApp is undefined, cannot start game');
                statusElement.textContent = 'Failed to start game: Telegram WebApp not available. Please reopen.';
                statusElement.classList.add('error');
                alert('Telegram WebApp is not available. Please reopen the app from Telegram.');
            }
        }

        function startClimbing(startData) {
            if (gameActive) return;
            logToBackend('INFO', `Starting climb with data: ${JSON.stringify(startData)}`);
            currentStake = startData.stake;
            currentToken = startData.token;
            gameActive = true;
            let altitude = 0;
            let multiplier = 1.0;
            updateUI();
            altitudeElement.textContent = `${altitude}m`;
            multiplierElement.textContent = `${multiplier.toFixed(2)}x`;
            nimsElement.style.bottom = '10px';

            climbInterval = setInterval(() => {
                altitude += 50;
                multiplier = 1.0 + (altitude / 1000);
                altitudeElement.textContent = `${altitude}m`;
                multiplierElement.textContent = `${multiplier.toFixed(2)}x`;
                nimsElement.style.bottom = `${10 + (altitude / 10)}px`;
                logToBackend('DEBUG', `Climbing: altitude=${altitude}m, multiplier=${multiplier.toFixed(2)}x`);

                const avalancheChance = Math.min(0.02 + (altitude / 50000), 0.1);
                if (Math.random() < avalancheChance) {
                    clearInterval(climbInterval);
                    gameActive = false;
                    const data = { action: 'lost', stake: currentStake, token: currentToken };
                    logToBackend('INFO', `Avalanche occurred, sending action to backend: ${JSON.stringify(data)}`);
                    WebApp.sendData(JSON.stringify(data));
                    statusElement.textContent = 'Avalanche! Nims fell!';
                    statusElement.classList.add('error');
                    updateUI();
                }
            }, 500);
        }

        function cashOut() {
            if (!gameActive) {
                statusElement.textContent = 'No active climb to cash out.';
                logToBackend('WARN', 'Attempted cashout with no active game');
                return;
            }
            clearInterval(climbInterval);
            const multiplier = parseFloat(multiplierElement.textContent);
            const data = { action: 'cashout', stake: currentStake, multiplier: multiplier, token: currentToken };
            logToBackend('INFO', `Preparing to send cashout to backend: ${JSON.stringify(data)}`);
            WebApp = window.Telegram?.WebApp || WebApp;
            if (WebApp) {
                try {
                    WebApp.sendData(JSON.stringify(data));
                    logToBackend('INFO', 'Cashout WebApp.sendData executed successfully');
                } catch (e) {
                    logToBackend('ERROR', `Cashout WebApp.sendData failed: ${e.message}`);
                    statusElement.textContent = 'Failed to cash out. Please try again.';
                    statusElement.classList.add('error');
                }
            } else {
                logToBackend('ERROR', 'WebApp is undefined, cannot send cashout');
            }
            gameActive = false;
            statusElement.textContent = `Cashed out at ${multiplier.toFixed(2)}x!`;
            updateUI();
        }

        function refreshBalance() {
            const data = { action: 'refresh_balance' };
            logToBackend('INFO', `Preparing to send refresh_balance to backend: ${JSON.stringify(data)}`);
            WebApp = window.Telegram?.WebApp || WebApp;
            if (WebApp) {
                try {
                    WebApp.sendData(JSON.stringify(data));
                    logToBackend('INFO', 'Refresh WebApp.sendData executed successfully');
                } catch (e) {
                    logToBackend('ERROR', `Refresh WebApp.sendData failed: ${e.message}`);
                    statusElement.textContent = 'Failed to refresh balance. Please try again.';
                    statusElement.classList.add('error');
                }
            } else {
                logToBackend('ERROR', 'WebApp is undefined, cannot send refresh');
            }
            statusElement.textContent = 'Requesting balance update...';
            statusElement.classList.remove('error');
        }

        startButton.addEventListener('click', startGame);
        cashoutButton.addEventListener('click', cashOut);
        refreshButton.addEventListener('click', refreshBalance);

        loadGameData();
    </script>
</body>
</html>

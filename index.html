<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nims Climb</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #007bff;
        }
        .balance {
            margin-bottom: 20px;
        }
        .balance p {
            margin: 5px 0;
            font-size: 16px;
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        select, input, button {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #game-area {
            margin-top: 20px;
            text-align: center;
        }
        #status {
            margin-top: 10px;
            font-weight: bold;
        }
        .error {
            color: red;
        }
        #climbing-area {
            display: none;
            margin-top: 20px;
        }
        #multiplier {
            font-size: 24px;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Nims Climb</h1>
        <div class="balance">
            <p>BNB Balance: <span id="bnb-balance">0.0000</span></p>
            <p>NIMS Balance: <span id="nims-balance">0.0000</span></p>
        </div>
        <div class="controls">
            <select id="token-select">
                <option value="BNB">BNB</option>
                <option value="NIMS">NIMS</option>
            </select>
            <input type="number" id="stake-input" placeholder="Enter stake (0.1 - 10)" step="0.1" min="0.1" max="10">
            <button id="start-button">Start Climbing</button>
            <button id="refresh-button">Refresh Balance</button>
        </div>
        <div id="game-area">
            <p id="status">Ready to play!</p>
            <div id="climbing-area">
                <p>Multiplier: <span id="multiplier">1.00x</span></p>
                <button id="cashout-button">Cash Out</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Telegram WebApp
        const WebApp = window.Telegram?.WebApp;
        if (!WebApp) {
            alert("This page must be opened in Telegram WebApp");
            document.getElementById('status').textContent = 'Error: Not in Telegram WebApp';
            document.getElementById('status').classList.add('error');
        } else {
            WebApp.ready();
            WebApp.expand();
        }

        // Elements
        const bnbBalanceElement = document.getElementById('bnb-balance');
        const nimsBalanceElement = document.getElementById('nims-balance');
        const tokenSelect = document.getElementById('token-select');
        const stakeInput = document.getElementById('stake-input');
        const startButton = document.getElementById('start-button');
        const refreshButton = document.getElementById('refresh-button');
        const statusElement = document.getElementById('status');
        const climbingArea = document.getElementById('climbing-area');
        const multiplierElement = document.getElementById('multiplier');
        const cashoutButton = document.getElementById('cashout-button');

        // Game state
        let gameData = {
            user_id: null,
            bnb_balance: 0.0,
            nims_balance: 0.0,
            bnb_address: 'Not generated',
            nims_address: 'Not generated',
            timestamp: 0
        };
        let gameActive = false;
        let currentStake = 0;
        let currentToken = '';
        let multiplierInterval = null;

        // Log function to send messages to backend
        function logToBackend(level, message) {
            if (WebApp) {
                const logData = {
                    action: 'log',
                    level: level,
                    message: message,
                    timestamp: new Date().toISOString()
                };
                WebApp.sendData(JSON.stringify(logData));
            }
            console.log(`${level}: ${message}`); // Also log to console for debugging
        }

        // Parse URL parameters
        function loadGameData() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            try {
                if (dataParam) {
                    gameData = JSON.parse(decodeURIComponent(dataParam));
                    logToBackend('INFO', `Web UI received data from backend: ${JSON.stringify(gameData)}`);
                    updateUI();
                } else {
                    logToBackend('WARN', 'Web UI received no data parameter in URL');
                    statusElement.textContent = 'No balance data received. Try refreshing.';
                    statusElement.classList.add('error');
                }
            } catch (e) {
                logToBackend('ERROR', `Web UI failed to parse game data: ${e.message}`);
                statusElement.textContent = 'Error loading balance data.';
                statusElement.classList.add('error');
            }
        }

        // Update UI with game data
        function updateUI() {
            bnbBalanceElement.textContent = parseFloat(gameData.bnb_balance || 0).toFixed(4);
            nimsBalanceElement.textContent = parseFloat(gameData.nims_balance || 0).toFixed(4);
            statusElement.textContent = gameActive ? 'Climbing...' : 'Ready to play!';
            statusElement.classList.remove('error');
            climbingArea.style.display = gameActive ? 'block' : 'none';
            startButton.disabled = gameActive;
            stakeInput.disabled = gameActive;
            tokenSelect.disabled = gameActive;
        }

        // Start game logic
        function startGame() {
            if (gameActive) {
                statusElement.textContent = 'Game already in progress.';
                return;
            }

            const token = tokenSelect.value;
            let stake = parseFloat(stakeInput.value);

            // Validate inputs
            if (!token || !['BNB', 'NIMS'].includes(token)) {
                statusElement.textContent = 'Please select a valid token.';
                statusElement.classList.add('error');
                logToBackend('WARN', 'Invalid token selected in Web UI');
                return;
            }
            if (isNaN(stake) || stake < 0.1 || stake > 10) {
                statusElement.textContent = 'Stake must be between 0.1 and 10.';
                statusElement.classList.add('error');
                logToBackend('WARN', `Invalid stake entered in Web UI: ${stakeInput.value}`);
                return;
            }

            // Check balance
            const balance = token === 'BNB' ? parseFloat(gameData.bnb_balance) : parseFloat(gameData.nims_balance);
            if (isNaN(balance)) {
                statusElement.textContent = 'Balance data invalid. Please refresh.';
                statusElement.classList.add('error');
                logToBackend('ERROR', 'Invalid balance data in Web UI');
                return;
            }
            if (stake > balance) {
                statusElement.textContent = `Insufficient ${token} balance: ${balance.toFixed(4)}.`;
                statusElement.classList.add('error');
                logToBackend('WARN', `Insufficient ${token} balance in Web UI: ${balance} < ${stake}`);
                return;
            }

            // Send data to bot
            const data = {
                action: 'start_game',
                token: token,
                stake: stake
            };
            statusElement.textContent = 'Starting game...';
            statusElement.classList.remove('error');
            logToBackend('INFO', `Web UI sending action to backend: ${JSON.stringify(data)}`);
            WebApp.sendData(JSON.stringify(data));

            // Store game state
            currentStake = stake;
            currentToken = token;
            gameActive = true;
            startClimbing();
        }

        // Simulate climbing game
        function startClimbing() {
            let multiplier = 1.0;
            updateUI();
            multiplierElement.textContent = `${multiplier.toFixed(2)}x`;
            multiplierInterval = setInterval(() => {
                multiplier += 0.05;
                multiplierElement.textContent = `${multiplier.toFixed(2)}x`;
                if (Math.random() < 0.05) {
                    clearInterval(multiplierInterval);
                    gameActive = false;
                    const data = {
                        action: 'lost',
                        stake: currentStake,
                        token: currentToken
                    };
                    logToBackend('INFO', `Web UI sending action to backend: ${JSON.stringify(data)}`);
                    WebApp.sendData(JSON.stringify(data));
                    statusElement.textContent = 'Crashed!';
                    statusElement.classList.add('error');
                    updateUI();
                }
            }, 500);
        }

        // Cash out
        function cashOut() {
            if (!gameActive) {
                statusElement.textContent = 'No active game to cash out.';
                return;
            }
            clearInterval(multiplierInterval);
            const multiplier = parseFloat(multiplierElement.textContent);
            const data = {
                action: 'cashout',
                stake: currentStake,
                multiplier: multiplier,
                token: currentToken
            };
            logToBackend('INFO', `Web UI sending action to backend: ${JSON.stringify(data)}`);
            WebApp.sendData(JSON.stringify(data));
            gameActive = false;
            statusElement.textContent = `Cashed out at ${multiplier.toFixed(2)}x!`;
            updateUI();
        }

        // Refresh balance
        function refreshBalance() {
            const data = { action: 'refresh_balance' };
            logToBackend('INFO', `Web UI sending action to backend: ${JSON.stringify(data)}`);
            WebApp.sendData(JSON.stringify(data));
            statusElement.textContent = 'Requesting balance update...';
            statusElement.classList.remove('error');
        }

        // Event listeners
        startButton.addEventListener('click', startGame);
        cashoutButton.addEventListener('click', cashOut);
        refreshButton.addEventListener('click', refreshBalance);

        // Initial load
        loadGameData();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <title>Nims Climb</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        #gameCanvas {
            flex: 1;
            width: 100%;
            background: url('mountain.jpg') no-repeat center center;
            background-size: cover;
        }
        #interface {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            color: white;
            text-shadow: 1px 1px 2px black;
        }
        #controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        #multiplier {
            font-size: 24px;
            font-weight: bold;
        }
        #balance {
            font-size: 18px;
        }
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        #stakeInput {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        #tokenSelect {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="interface">
        <div id="multiplier">1.00x</div>
        <div id="balance">BNB: 0 | NIMS: 0</div>
    </div>
    <canvas id="gameCanvas"></canvas>
    <div id="controls">
        <input type="number" id="stakeInput" placeholder="Stake (0.1-10)" step="0.1" min="0.1" max="10">
        <select id="tokenSelect">
            <option value="BNB">BNB</option>
            <option value="NIMS">NIMS</option>
        </select>
        <button id="startButton">Start Game</button>
        <button id="cashoutButton" disabled>Cash Out</button>
        <button id="restButton" disabled>Rest</button>
    </div>
    <div id="error"></div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const multiplierDisplay = document.getElementById('multiplier');
        const balanceDisplay = document.getElementById('balance');
        const stakeInput = document.getElementById('stakeInput');
        const tokenSelect = document.getElementById('tokenSelect');
        const startButton = document.getElementById('startButton');
        const cashoutButton = document.getElementById('cashoutButton');
        const restButton = document.getElementById('restButton');
        const errorDisplay = document.getElementById('error');

        let gameData = null;
        let sessionId = null;
        let stake = 0;
        let token = 'BNB';
        let crashPoint = 0;
        let multiplier = 1;
        let timeElapsed = 0;
        let isGameRunning = false;
        let climberY = 0;
        const climberSpeed = 0.5;

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        function showError(message) {
            errorDisplay.textContent = message;
            errorDisplay.style.display = 'block';
            setTimeout(() => errorDisplay.style.display = 'none', 5000);
            console.error('Error:', message);
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - 100;
            climberY = canvas.height - 50;
        }

        function drawClimber() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(canvas.width / 2 - 10, climberY, 20, 20);
            climberY -= climberSpeed * (multiplier / 1.5);
            if (climberY < 0) climberY = 0;
        }

        function updateGame() {
            if (!isGameRunning) return;
            timeElapsed += 0.016; // ~60 FPS
            multiplier = 1 + timeElapsed * 0.05;
            multiplierDisplay.textContent = multiplier.toFixed(2) + 'x';
            drawClimber();
            console.log(`Game tick: multiplier=${multiplier.toFixed(2)}, crashPoint=${crashPoint}, timeElapsed=${timeElapsed.toFixed(3)}`);
            if (crashPoint && multiplier >= crashPoint) {
                isGameRunning = false;
                multiplierDisplay.textContent = 'Avalanche!';
                cashoutButton.disabled = true;
                restButton.disabled = true;
                startButton.disabled = false;
                console.log('Game ended: Avalanche hit');
                Telegram.WebApp.sendData(JSON.stringify({
                    action: 'lost',
                    session_id: sessionId,
                    stake: stake.toString(),
                    token: token
                }));
                resetGame();
            } else {
                // Check if rest is possible
                const safetyZones = [1.5, 3.0, 5.0];
                restButton.disabled = !safetyZones.some(zone => Math.abs(multiplier - zone) < 0.1);
            }
            requestAnimationFrame(updateGame);
        }

        function resetGame() {
            isGameRunning = false;
            multiplier = 1;
            timeElapsed = 0;
            climberY = canvas.height - 50;
            multiplierDisplay.textContent = '1.00x';
            cashoutButton.disabled = true;
            restButton.disabled = true;
            startButton.disabled = false;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            console.log('Game reset');
        }

        function validateStake() {
            const value = parseFloat(stakeInput.value);
            return value >= 0.1 && value <= 10 && !isNaN(value);
        }

        try {
            const rawData = getQueryParam('data');
            if (!rawData) {
                throw new Error('No game data provided in URL');
            }
            gameData = JSON.parse(decodeURIComponent(rawData));
            console.log('Game data received:', gameData);
            balanceDisplay.textContent = `BNB: ${parseFloat(gameData.bnb_balance).toFixed(8)} | NIMS: ${parseFloat(gameData.nims_balance).toFixed(4)}`;
            if (gameData.game_started) {
                sessionId = gameData.game_started.session_id;
                stake = parseFloat(gameData.game_started.stake);
                token = gameData.game_started.token;
                crashPoint = parseFloat(gameData.game_started.crash_point);
                console.log('Game started:', { sessionId, stake, token, crashPoint });
                if (!sessionId || !stake || !token || !crashPoint) {
                    throw new Error('Incomplete game_started data');
                }
                isGameRunning = true;
                startButton.disabled = true;
                cashoutButton.disabled = false;
                restButton.disabled = false;
                stakeInput.value = stake;
                tokenSelect.value = token;
                stakeInput.disabled = true;
                tokenSelect.disabled = true;
                requestAnimationFrame(updateGame);
            } else {
                console.log('No active game, waiting for start');
                stakeInput.disabled = false;
                tokenSelect.disabled = false;
                startButton.disabled = false;
            }
        } catch (e) {
            showError(`Failed to load game: ${e.message}`);
            resetGame();
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        startButton.addEventListener('click', () => {
            if (!validateStake()) {
                showError('Stake must be between 0.1 and 10');
                return;
            }
            const stakeValue = parseFloat(stakeInput.value).toFixed(8);
            token = tokenSelect.value;
            console.log('Starting game:', { stake: stakeValue, token });
            Telegram.WebApp.sendData(JSON.stringify({
                action: 'start_game',
                token: token,
                stake: stakeValue
            }));
            startButton.disabled = true;
            stakeInput.disabled = true;
            tokenSelect.disabled = true;
        });

        cashoutButton.addEventListener('click', () => {
            if (!isGameRunning) return;
            isGameRunning = false;
            console.log('Cashout requested:', { sessionId, stake, token, multiplier });
            Telegram.WebApp.sendData(JSON.stringify({
                action: 'cashout',
                session_id: sessionId,
                stake: stake.toString(),
                token: token,
                multiplier: multiplier.toFixed(4)
            }));
            resetGame();
        });

        restButton.addEventListener('click', () => {
            if (!isGameRunning) return;
            const safetyZones = [1.5, 3.0, 5.0];
            if (!safetyZones.some(zone => Math.abs(multiplier - zone) < 0.1)) {
                showError('Can only rest at 1.5x, 3x, or 5x');
                return;
            }
            isGameRunning = false;
            console.log('Rest requested:', { sessionId, token, multiplier });
            Telegram.WebApp.sendData(JSON.stringify({
                action: 'rest',
                session_id: sessionId,
                token: token,
                multiplier: multiplier.toFixed(4)
            }));
            resetGame();
        });

        // Initialize Telegram WebApp
        Telegram.WebApp.ready();
        console.log('WebApp initialized');
    </script>
</body>
</html>

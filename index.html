<!DOCTYPE html>
<html>
<head>
    <title>Nims Climb</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: Arial; text-align: center; background: #87CEEB; margin: 0; padding: 20px; font-size: 20px; }
        canvas { border: 1px solid black; background: #808080; display: none; width: 600px; height: 800px; margin: 0 auto; }
        #ui { margin-bottom: 20px; }
        button { padding: 15px 30px; margin: 10px; font-size: 24px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 5px; }
        select, input { padding: 10px; font-size: 24px; margin: 10px; width: 200px; }
        #result { font-size: 24px; margin-top: 20px; color: #ff4444; }
        #cashoutBtn { font-size: 36px; font-weight: bold; padding: 20px 40px; background-color: #FFD700; color: black; position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); }
        h2 { font-size: 36px; }
        h3 { font-size: 28px; }
        p { font-size: 28px; }
        .section { margin: 20px 0; padding: 15px; background: rgba(255, 255, 255, 0.8); border-radius: 10px; }
        #depositAddress { font-size: 20px; word-wrap: break-word; margin-top: 10px; display: none; }
        .hidden { display: none; }
        .address-display { word-break: break-all; font-size: 18px; margin: 10px 0; }
        .wallet-info { margin-top: 20px; padding: 15px; background: rgba(255, 255, 255, 0.9); border-radius: 8px; }
    </style>
</head>
<body>
    <div id="ui">
        <h2>üèî Nims Climb</h2>
        <p>Balance: <span id="bnbBalance">0</span> BNB | <span id="nimsBalance">0</span> NIMS</p>
        <button id="refreshBtn">Refresh Balance</button>

        <!-- Wallet Address Display -->
        <div class="section wallet-info">
            <h3>Wallet Addresses</h3>
            <p>BNB Address: <span class="address-display" data-token="bnb" id="bnbAddress"></span></p>
            <p>NIMS Address: <span class="address-display" data-token="nims" id="nimsAddress"></span></p>
        </div>

        <div class="section" id="gameControls">
            <h3>Play Game</h3>
            <label>Token: 
                <select id="tokenSelect">
                    <option value="BNB">BNB</option>
                    <option value="NIMS">NIMS</option>
                </select>
            </label><br>
            <label>Stake (0.1‚Äì10): 
                <input type="number" id="stakeInput" step="0.01" min="0.1" max="10" value="0.1">
            </label><br>
            <button id="startBtn">Start Climbing</button>
        </div>

        <div class="section" id="walletActions">
            <h3>Wallet Actions</h3>
            <label>Amount: <input type="number" id="amountInput" step="0.01" min="0.1" value="0.1"></label><br>
            <label>Token: <select id="walletTokenSelect">
                <option value="BNB">BNB</option>
                <option value="NIMS">NIMS</option>
            </select></label><br>
            <button id="depositBtn">Deposit</button>
            <button id="withdrawBtn">Withdraw</button>
            <div id="depositAddress">
                <p id="addressText"></p>
                <button id="copyAddressBtn">Copy Address</button>
            </div>
        </div>

        <div class="section" id="raffleActions">
            <h3>Raffle (1 NIMS/ticket)</h3>
            <button id="buyRaffleBtn">Buy Raffle Ticket</button>
        </div>
    </div>
    
    <canvas id="gameCanvas" width="600" height="800"></canvas>
    <button id="cashoutBtn" class="hidden">Cash Out</button>
    <div id="result"></div>

    <script>
        function log(message) {
            const timestamp = new Date().toISOString();
            console.log(`[DEBUG][${timestamp}] ${message}`);
            document.getElementById('result').textContent = message.substring(0, 100);
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const elements = {
            startBtn: document.getElementById('startBtn'),
            cashoutBtn: document.getElementById('cashoutBtn'),
            depositBtn: document.getElementById('depositBtn'),
            withdrawBtn: document.getElementById('withdrawBtn'),
            buyRaffleBtn: document.getElementById('buyRaffleBtn'),
            refreshBtn: document.getElementById('refreshBtn'),
            resultDiv: document.getElementById('result'),
            depositAddressDiv: document.getElementById('depositAddress'),
            addressText: document.getElementById('addressText'),
            copyAddressBtn: document.getElementById('copyAddressBtn'),
            bnbAddress: document.getElementById('bnbAddress'),
            nimsAddress: document.getElementById('nimsAddress')
        };

        let gameState = {
            height: 0,
            multiplier: 1.0,
            gameActive: false,
            stake: 0,
            token: '',
            userId: null,
            balances: { bnb: 0, nims: 0 },
            addresses: { bnb: null, nims: null }
        };

        function initializeGame() {
            log('Initializing game...');
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const gameData = JSON.parse(urlParams.get('data') || '{}');
                
                gameState.userId = gameData.user_id || Telegram.WebApp.initDataUnsafe.user?.id;
                gameState.balances.bnb = parseFloat(gameData.bnb_balance) || 0;
                gameState.balances.nims = parseFloat(gameData.nims_balance) || 0;
                gameState.addresses.bnb = gameData.bnb_address || "Address not available";
                gameState.addresses.nims = gameData.nims_address || "Address not available";

                updateDisplay();
                log('Game initialized with: ' + JSON.stringify(gameData));
            } catch (error) {
                log(`Initialization error: ${error.message}`);
            }
        }

        function updateDisplay() {
            // Update balances
            document.getElementById('bnbBalance').textContent = gameState.balances.bnb.toFixed(4);
            document.getElementById('nimsBalance').textContent = gameState.balances.nims.toFixed(4);
            
            // Update addresses
            elements.bnbAddress.textContent = gameState.addresses.bnb;
            elements.nimsAddress.textContent = gameState.addresses.nims;
            
            // Update deposit address visibility
            elements.depositAddressDiv.style.display = 
                gameState.addresses.bnb && gameState.addresses.nims ? 'block' : 'none';
        }


    function handleIncomingMessage(event) {
    try {
        const message = event.data.text;
        if (message.startsWith('Balance update: ')) {
            const balanceData = JSON.parse(message.split('Balance update: ')[1]);
            
            // Validate numbers
            gameState.balances.bnb = typeof balanceData.bnb_balance === 'number' ? balanceData.bnb_balance : 0;
            gameState.balances.nims = typeof balanceData.nims_balance === 'number' ? balanceData.nims_balance : 0;
            
            // Validate addresses
            gameState.addresses.bnb = typeof balanceData.bnb_address === 'string' ? 
                (balanceData.bnb_address.startsWith('0x') ? balanceData.bnb_address : 'Invalid address') : 
                'Not available';
            
            gameState.addresses.nims = typeof balanceData.nims_address === 'string' ? 
                (balanceData.nims_address.startsWith('0x') ? balanceData.nims_address : 'Invalid address') : 
                'Not available';

            updateDisplay();
        }
    } catch (error) {
        console.error('Message handling error:', error);
    }
}

function updateDisplay() {
    // Format numbers properly
    document.getElementById('bnbBalance').textContent = gameState.balances.bnb.toLocaleString('en', {
        minimumFractionDigits: 4,
        maximumFractionDigits: 4
    });
    
    document.getElementById('nimsBalance').textContent = gameState.balances.nims.toLocaleString('en', {
        minimumFractionDigits: 4,
        maximumFractionDigits: 4
    });

    // Update addresses with validation
    elements.bnbAddress.textContent = gameState.addresses.bnb;
    elements.bnbAddress.style.color = gameState.addresses.bnb.startsWith('0x') ? 'green' : 'red';
    
    elements.nimsAddress.textContent = gameState.addresses.nims;
    elements.nimsAddress.style.color = gameState.addresses.nims.startsWith('0x') ? 'green' : 'red';
}
        // Modified message handler
        Telegram.WebApp.onEvent('message', (event) => {
            try {
                const message = event.data.text;
                if (message.startsWith('Balance update: ')) {
                    const balanceData = JSON.parse(message.split('Balance update: ')[1]);
                    
                    gameState.balances.bnb = parseFloat(balanceData.bnb_balance) || 0;
                    gameState.balances.nims = parseFloat(balanceData.nims_balance) || 0;
                    gameState.addresses.bnb = balanceData.bnb_address || "Address not available";
                    gameState.addresses.nims = balanceData.nims_address || "Address not available";
                    
                    updateDisplay();
                    elements.resultDiv.textContent = "Balances updated!";
                }
            } catch (error) {
                log(`Message error: ${error.message}`);
            }
        });

        // Rest of the game logic remains the same...

        // Start the application
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        initializeGame();
        setupEventListeners();
    </script>
</body>
</html>

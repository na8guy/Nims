<!DOCTYPE html>
<html>
<head>
    <title>Nims Climb</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ... (keep existing styles the same) ... */
    </style>
</head>
<body>
    <!-- ... (keep existing HTML structure the same) ... -->
    <script>
        // ... (keep existing variable declarations the same) ...

        function updateBalances(newBnbBalance, newNimsBalance, newBnbAddress, newNimsAddress) {
            bnbBalance = newBnbBalance;
            nimsBalance = newNimsBalance;
            bnbAddress = newBnbAddress;
            nimsAddress = newNimsAddress;
            document.getElementById('bnbBalance').textContent = bnbBalance.toFixed(4);
            document.getElementById('nimsBalance').textContent = nimsBalance.toFixed(4);
        }

        function showGameUI(show) {
            document.getElementById('ui').style.display = show ? 'block' : 'none';
            canvas.style.display = show ? 'none' : 'block';
            cashoutBtn.style.display = show ? 'none' : 'block';
        }

        // ... (keep existing draw() and gameLoop() functions the same) ...

        cashoutBtn.addEventListener('click', () => {
            if (gameActive) {
                gameActive = false;
                showGameUI(true);
                const winnings = stake * multiplier;
                Telegram.WebApp.sendData(JSON.stringify({
                    action: 'cashout',
                    stake: stake,
                    token: token,
                    multiplier: multiplier
                }));
            }
        });

        // Modified message handler
        Telegram.WebApp.onEvent('message', (event) => {
            const message = event.data.text;
            if (message.startsWith('Balance update: ')) {
                try {
                    const balanceData = JSON.parse(message.split('Balance update: ')[1]);
                    if (balanceData.action === 'update_balance') {
                        updateBalances(
                            balanceData.bnb_balance,
                            balanceData.nims_balance,
                            balanceData.bnb_address,
                            balanceData.nims_address
                        );
                        document.getElementById('result').textContent = "Balances updated!";
                    }
                } catch(e) {
                    console.error("Balance update error:", e);
                }
            }
        });

        // Modified deposit handler
        depositBtn.addEventListener('click', () => {
            const amount = parseFloat(document.getElementById('amountInput').value);
            const token = document.getElementById('walletTokenSelect').value;
            const depositAddress = token === 'BNB' ? bnbAddress : nimsAddress;
            
            if (!depositAddress) {
                document.getElementById('result').textContent = "Address not found! Please restart the bot.";
                return;
            }

            addressText.textContent = `Send ${amount} ${token} to: ${depositAddress}`;
            depositAddressDiv.style.display = 'block';
            Telegram.WebApp.sendData(JSON.stringify({
                action: 'deposit',
                amount: amount,
                token: token
            }));
        });

        // ... (keep other event listeners the same) ...

        Telegram.WebApp.ready();
    </script>
</body>
</html>
